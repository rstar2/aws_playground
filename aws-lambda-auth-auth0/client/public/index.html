<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <title>Authentication with Auth0 (server side) before calling AWS Lambda</title>
</head>

<body>
    <button id='loginServer'>Login with Auth0 in server</button>
    <input type="text" id="username">
    <input type="text" id="password">
    <hr>

    <!-- TODO: implement -->
    <button id='loginHosted'>Login with Auth0 hosted page</button>
    <hr>

    <button id='loginLock'>Login with Auth0 Lock widget</button>
    <hr>

    <button id='api'>API auth test</button>

    <script>
        (() => {
            let authToken = null;
            document.getElementById('loginServer').addEventListener('click', () => {
                fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value,
                    }),
                })
                    .then(res => res.json())
                    .then(({ auth, token }) => {
                        if (auth) {
                            authToken = token;
                            alert('Logged in');
                        }
                    });

            });


            const API_AUTHORIZED_URL = 'https://a57997ppt6.execute-api.eu-central-1.amazonaws.com/dev/api';
            document.getElementById('api').addEventListener('click', () => {
                fetch(API_AUTHORIZED_URL + '/test', {
                    headers: (() => {
                        return authToken ? {
                            'Authorization': 'Bearer ' + authToken,
                        } : {};
                    })(),
                })
                    .then(res => res.json())
                    .then(() => {
                        alert('Success');
                    })
                    .catch(error => {
                        console.error(error);
                        alert('Failure: ' + error);
                    });
            });
        })();
    </script>

</body>

</html>
